const functions = require("firebase-functions");
const admin = require("firebase-admin");

admin.initializeApp();
const db = admin.database();

exports.submitSignupRequest = functions.https.onRequest((req, res) => {
  const origin = req.headers.origin;

  if (origin === "https://woodyhu9512.github.io") {
    res.set("Access-Control-Allow-Origin", origin);
    res.set("Vary", "Origin");
  }

  res.set("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.set("Access-Control-Allow-Headers", "Content-Type");
  res.set("Access-Control-Allow-Credentials", "true");

  if (req.method === "OPTIONS") {
    return res.status(204).send("");
  }

  const { realName, fbName, bankLast5, username, password, selectedSchools, totalPrice } = req.body;

  if (!realName || !fbName || !bankLast5 || !username || !password || !selectedSchools || totalPrice === undefined) {
    return res.status(400).json({ error: "❌ 缺少欄位資料" });
  }

  const timestamp = Date.now();
  db.ref(`pendingUsers/${username}_${timestamp}`).set({
    "真實姓名": realName,
    "Facebook資訊": fbName,
    "銀行帳號後五碼": bankLast5,
    "申請帳號": username,
    "申請密碼": password,
    "選擇學校": selectedSchools,
    "總金額": totalPrice,
    "送出時間": new Date().toLocaleString("zh-TW", { timeZone: "Asia/Taipei" })
  }).then(() => {
    return res.status(200).json({ success: true, message: "✅ 已送出申請，請等待審核" });
  }).catch(err => {
    console.error("❌ 儲存失敗：", err);
    return res.status(500).json({ error: "伺服器錯誤" });
  });
});
