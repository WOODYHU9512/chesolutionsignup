<!-- 修改後 admin 註冊頁面 -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>化工製造所註冊與付款登記系統</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .header img {
      height: 60px;
      border-radius: 8px;
    }
    h2 {
      margin: 0;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    .school-option {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    .school-option label {
      margin: 0;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    footer {
      text-align: center;
      font-size: 12px;
      margin-top: 30px;
      color: #555;
    }
    .note {
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://raw.githubusercontent.com/WOODYHU9512/cheisgood/main/%E7%9C%9F%E6%AD%A3LOGO.jpeg" alt="logo">
    <h2>化工製造所註冊與付款登記系統</h2>
  </div>

  <label>您的真實姓名：<input type="text" id="realName" required></label>
  <label>個人Facebook網址(聯絡用)：<input type="text" id="fbName" required></label>

  <label>選擇付款方式：
    <select id="paymentMethod" onchange="showPaymentInput()">
      <option value="">請選擇</option>
      <option value="街口支付">街口支付轉帳</option>
      <option value="iPass money">iPass money轉帳</option>
      <option value="銀行轉帳">銀行轉帳</option>
    </select>
  </label>
  <div id="paymentInput"></div>

  <h3>要購買哪幾間考古題?(請勾選)</h3>
  <div id="schools"></div>
  <p><strong>總金額：<span id="total">0</span> 元</strong></p>

  <label>設定觀看帳號：<input type="text" id="username" required></label>
  <label>設定觀看密碼：<input type="password" id="password" required></label>

  <button onclick="submitForm()">送出申請</button>
  <button onclick="clearForm()">清空所有欄位</button>

  <footer>
    <p>若有操作相關疑問，請聯絡 <a href="https://www.facebook.com/CHEisverygood/" target="_blank">Facebook 粉專</a> 或來信 <a href="mailto:cheerfactorysolution@gmail.com">cheerfactorysolution@gmail.com</a></p>
    <p>著作權所有，侵害必究 © 化工製造所</p>
  </footer>

  <script>
    const schoolPrices = {
      "台大": 600, "清大": 700, "成大": 700,
      "中央": 550, "台科大": 550, "中興": 550
    };
    const discount = [0, 0, 100, 200, 350, 500, 800];
    const schoolDiv = document.getElementById("schools");
    const totalDisplay = document.getElementById("total");
    for (const [school, price] of Object.entries(schoolPrices)) {
      const div = document.createElement("div");
      div.className = "school-option";
      div.innerHTML = `<label><input type="checkbox" value="${school}" onchange="updateTotal()"> ${school}（${price} 元）</label>`;
      schoolDiv.appendChild(div);
    }

    function updateTotal() {
      const checkboxes = document.querySelectorAll("#schools input[type=checkbox]:checked");
      let sum = 0;
      checkboxes.forEach(cb => sum += schoolPrices[cb.value]);
      const d = discount[checkboxes.length] || 0;
      totalDisplay.innerText = sum - d;
    }

    function clearForm() {
      document.getElementById("realName").value = "";
      document.getElementById("fbName").value = "";
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      document.getElementById("paymentInput").innerHTML = "";
      document.getElementById("paymentMethod").value = "";
      document.querySelectorAll("#schools input[type=checkbox]").forEach(cb => cb.checked = false);
      updateTotal();
    }

    function showPaymentInput() {
      const method = document.getElementById("paymentMethod").value;
      const container = document.getElementById("paymentInput");
      let html = "";
      if (method === "街口支付") {
        html = `<label>您的街口帳戶：<input type="text" id="accountInput"></label>
                <p class="note"><a href="https://drive.google.com/file/d/1tXpoUGAFQYR0JkMHqPY1Wy7tqOBDUtzZ/view" target="_blank">街口帳戶轉帳教學</a></p>`;
      } else if (method === "iPass money") {
        html = `<label>您的 iPass money 帳號：<input type="text" id="accountInput"></label>
                <p class="note"><a href="https://drive.google.com/file/d/1Xea7qybNVBZSaERUWQ5PpWmcyQzQ9p0T/view" target="_blank">iPass money 轉帳教學</a></p>`;
      } else if (method === "銀行轉帳") {
        html = `<label>銀行帳號後五碼：<input type="text" id="accountInput"></label>
                <p class="note"><a href="https://drive.google.com/file/d/1yZT6J67mfJiE9nIQePPbE59oKcP3zv4g/view" target="_blank">銀行轉帳教學</a></p>`;
      }
      container.innerHTML = html;
    }

    async function submitForm() {
      const realName = document.getElementById("realName").value.trim();
      const fbName = document.getElementById("fbName").value.trim();
      const paymentMethod = document.getElementById("paymentMethod").value;
      const accountInput = document.getElementById("accountInput")?.value.trim();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      const selectedSchools = Array.from(document.querySelectorAll("#schools input[type=checkbox]:checked")).map(cb => cb.value);
      const totalPrice = parseInt(document.getElementById("total").innerText);

      if (!realName || !fbName || !paymentMethod || !accountInput || !username || !password || selectedSchools.length === 0) {
        alert("❌ 請填寫所有欄位並至少勾選一所學校！");
        return;
      }

      const fbUrlPattern = /^https?:\/\/(www\.)?facebook\.com\/[a-zA-Z0-9\.]+$/;
      if (!fbUrlPattern.test(fbName)) {
        alert("❌ Facebook 個人網址格式不正確！");
        return;
      }

      const existsCheck = await fetch("https://us-central1-chesolutionsignup.cloudfunctions.net/checkUsernameExists", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
      });
      const existsData = await existsCheck.json();
      if (existsData.exists) {
        alert(`⚠️ 帳號 ${username} 已被註冊，請改用其他帳號！`);
        return;
      }

      const payload = {
        realName, fbName, paymentMethod,
        paymentInfo: accountInput,
        username, password, selectedSchools, totalPrice
      };

      const res = await fetch("https://us-central1-chesolutionsignup.cloudfunctions.net/submitSignupRequest", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (data.success) {
        alert("✅ 送出成功，請耐心等待審核！");
        clearForm();
      } else {
        alert("❌ 發生錯誤：" + (data.error || "請稍後再試"));
      }
    }
  </script>
</body>
</html>
