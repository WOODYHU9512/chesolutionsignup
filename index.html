<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>註冊頁面</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    h2 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    .school-option {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    .school-option label {
      margin: 0;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
      color: green;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>註冊系統</h2>
  <label>真實姓名：<input type="text" id="realName" required></label>
  <label>Facebook姓名與網址：<input type="text" id="fbName" required></label>
  <label>銀行帳號後五碼：<input type="text" id="bankLast5" required></label>

  <h3>欲購買的間數：</h3>
  <div id="schools"></div>

  <p><strong>總金額：<span id="total">0</span> 元</strong></p>

  <label>申請帳號：<input type="text" id="username" required></label>
  <label>申請密碼：<input type="password" id="password" required></label>

  <button onclick="submitForm()">送出申請</button>
  <button onclick="clearForm()">清空所有欄位</button>
  <div id="result"></div>

  <script>
    const schoolPrices = {
      "台大": 600,
      "清大": 700,
      "成大": 700,
      "中央": 550,
      "台科大": 550,
      "中興": 550
    };

    const discount = [0, 0, 100, 200, 350, 500, 800];
    const schoolDiv = document.getElementById("schools");
    const totalDisplay = document.getElementById("total");

    for (const [school, price] of Object.entries(schoolPrices)) {
      const div = document.createElement("div");
      div.className = "school-option";
      div.innerHTML = `
        <label><input type="checkbox" value="${school}" onchange="updateTotal()"> ${school}（${price} 元）</label>
      `;
      schoolDiv.appendChild(div);
    }

    function updateTotal() {
      const checkboxes = document.querySelectorAll("#schools input[type=checkbox]:checked");
      let sum = 0;
      checkboxes.forEach(cb => {
        sum += schoolPrices[cb.value];
      });
      const d = discount[checkboxes.length] || 0;
      totalDisplay.innerText = sum - d;
    }

    function clearForm() {
      document.getElementById("realName").value = "";
      document.getElementById("fbName").value = "";
      document.getElementById("bankLast5").value = "";
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      document.querySelectorAll("#schools input[type=checkbox]").forEach(cb => cb.checked = false);
      updateTotal();
      document.getElementById("result").innerText = "";
    }

    async function submitForm() {
  const realName = document.getElementById("realName").value.trim();
  const fbName = document.getElementById("fbName").value.trim();
  const bankLast5 = document.getElementById("bankLast5").value.trim();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const selectedSchools = Array.from(document.querySelectorAll("#schools input[type=checkbox]:checked")).map(cb => cb.value);
  const totalPrice = parseInt(document.getElementById("total").innerText);

  if (!realName || !fbName || !bankLast5 || !username || !password || selectedSchools.length === 0) {
    alert("❌ 請填寫所有欄位並至少勾選一所學校！");
    return;
  }

  const payload = {
    realName,
    fbName,
    bankLast5,
    username,
    password,
    selectedSchools,
    totalPrice
  };

  try {
    const res = await fetch("https://us-central1-chesolutionsignup.cloudfunctions.net/submitSignupRequest", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.success) {
      document.getElementById("result").innerHTML = `
        ✅ 送出成功，請耐心等待審核！<br>
        若有問題請私訊 <a href="https://www.facebook.com/CHEisverygood" target="_blank">粉專</a>。
      `;
      clearForm();
    } else {
      document.getElementById("result").innerText = "❌ 發生錯誤：" + (data.error || "請稍後再試");
    }
  } catch (err) {
    console.error(err);
    document.getElementById("result").innerText = "🚨 無法連線，請稍後再試。";
  }
}

  </script>
</body>
</html>
